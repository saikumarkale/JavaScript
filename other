const { Storage } = require('@google-cloud/storage');
const fp = require('fastify-plugin');
const path = require('path');

// Mocking fastify
const fastifyMock = {
  log: {
    trace: jest.fn(),
    error: jest.fn()
  },
  decorate: jest.fn()
};

// Mocking Storage class and its methods
jest.mock('@google-cloud/storage', () => ({
  Storage: jest.fn().mockImplementation(() => ({
    bucket: jest.fn().mockReturnThis(),
    file: jest.fn().mockReturnThis(),
    download: jest.fn()
  }))
}));

// Mocking path module
jest.mock('path', () => ({
  dirname: jest.fn(),
  join: jest.fn()
}));

describe('downloadPlugin', () => {
  let downloadPlugin;

  beforeAll(() => {
    downloadPlugin = require('./downloadPlugin');
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  it('should decorate fastify with downloadFileFromGcs', async () => {
    await downloadPlugin(fastifyMock);
    expect(fastifyMock.decorate).toHaveBeenCalledWith('downloadFileFromGcs', expect.any(Function));
  });

  it('should download file from GCS bucket', async () => {
    const fileName = 'example.txt';
    const gcsBucketName = 'bucket';
    const gcsDirName = 'dir';
    const destinationFilePath = '/path/to/downloads/example.txt';

    // Mocking path methods
    path.dirname.mockReturnValue('/path/to/main');

    // Calling the decorated function
    await fastifyMock.downloadFileFromGcs(gcsBucketName, gcsDirName, fileName);

    // Expectations
    expect(Storage).toHaveBeenCalledTimes(1);
    expect(Storage).toHaveBeenCalledWith();

    expect(fastifyMock.log.trace).toHaveBeenCalledWith('gcp Download Plugin starts');
    expect(path.dirname).toHaveBeenCalledWith(expect.any(String));
    expect(path.join).toHaveBeenCalledWith('/path/to/main', '../downloads/example.txt');
    expect(fastifyMock.log.trace).toHaveBeenCalledWith(expect.stringContaining('downloaded to'));
    expect(fastifyMock.log.error).not.toHaveBeenCalled();
  });

  it('should handle error while downloading file from GCS bucket', async () => {
    const errorMessage = 'Error message';
    const error = new Error(errorMessage);
    Storage.mockImplementationOnce(() => ({
      bucket: jest.fn().mockReturnThis(),
      file: jest.fn().mockReturnThis(),
      download: jest.fn().mockRejectedValue(error)
    }));

    // Calling the decorated function
    await expect(fastifyMock.downloadFileFromGcs('bucket', 'dir', 'example.txt')).rejects.toThrowError(errorMessage);

    // Expectations
    expect(fastifyMock.log.error).toHaveBeenCalledWith('Error while downloading file from gcp Bucket');
  });
});
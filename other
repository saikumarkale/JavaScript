const fastify = require('fastify')();
const fileHandlerPlugin = require('./fileHandlerPlugin');

describe('File Handler Plugin', () => {
  beforeAll(async () => {
    await fastify.register(fileHandlerPlugin);
  });

  afterAll(async () => {
    await fastify.close();
  });

  describe('deleteFile', () => {
    it('should delete an existing file', async () => {
      const filePath = './testFile.txt';
      // Create a test file
      fs.writeFileSync(filePath, 'Test content');
      
      // Call the deleteFile method
      await fastify.deleteFile(filePath);

      // Check if the file is deleted
      expect(fs.existsSync(filePath)).toBe(false);
    });

    it('should not throw an error when deleting a non-existing file', async () => {
      const filePath = './nonExistingFile.txt';
      
      // Call the deleteFile method
      await expect(fastify.deleteFile(filePath)).resolves.not.toThrow();
    });

    it('should throw an error when encountering an error during file deletion', async () => {
      const filePath = './readonlyFile.txt';
      // Create a test file
      fs.writeFileSync(filePath, 'Test content');
      // Make the file read-only
      fs.chmodSync(filePath, '444');
      
      // Call the deleteFile method
      await expect(fastify.deleteFile(filePath)).rejects.toThrow();
      
      // Restore file permissions
      fs.chmodSync(filePath, '644');
    });
  });
});